---
import Shell from "../../layouts/Shell.astro";
import PostPreview from "../../components/PostPreview.astro";
import { getCollection, getEntry, type CollectionEntry } from "astro:content";

type CategorySlug = "poesia" | "narrativa" | "critica" | "ensayo" | "epistolario";

const CATEGORY_LABEL: Record<CategorySlug, string> = {
  poesia: "Poesía",
  narrativa: "Narrativa",
  critica: "Crítica",
  ensayo: "Ensayo",
  epistolario: "Epistolario",
};

export async function getStaticPaths() {
  const slugs: CategorySlug[] = ["poesia", "narrativa", "critica", "ensayo", "epistolario"];

  return slugs.map((category: CategorySlug) => ({
    params: { category },
    props: { category },
  }));
}

const { category } = Astro.props as { category: CategorySlug };
const label = CATEGORY_LABEL[category];

const posts: CollectionEntry<"posts">[] = await getCollection("posts");

const filtered: CollectionEntry<"posts">[] = posts
  .filter((p: CollectionEntry<"posts">) => p.data.category === label)
  .slice()
  .sort(
    (a: CollectionEntry<"posts">, b: CollectionEntry<"posts">) =>
      b.data.date.valueOf() - a.data.date.valueOf()
  );

const filteredWithAuthors: { post: CollectionEntry<"posts">; author: CollectionEntry<"authors"> }[] =
  await Promise.all(
    filtered.map(async (post: CollectionEntry<"posts">) => {
      const author = await getEntry(post.data.author);
      if (!author) throw new Error(`Author not found for post: ${post.slug}`);
      return { post, author };
    })
  );
---

<Shell title={`${label} · El Gallo Galante`} description={`Textos de ${label}.`}>
  <div class="max-w-6xl mx-auto px-6">
    <header class="max-w-3xl mx-auto mb-16 md:mb-24 text-center">
      <p class="text-[10px] tracking-[0.3em] uppercase font-semibold text-stone-500 inline-block">
        Sección
      </p>

      <h1 class="display-serif text-4xl md:text-7xl font-bold leading-tight mt-6">
        {label}
      </h1>

      <p class="serif text-lg md:text-xl text-stone-500 leading-relaxed mt-6 max-w-2xl mx-auto">
        {label === "Poesía" && "Una constelación de voces. Fragmentos para leer despacio."}
        {label === "Narrativa" && "Relatos, escenas y memoria. Historias para habitar."}
        {label === "Crítica" && "Lecturas, preguntas y fricción. Pensar con el texto."}
        {label === "Ensayo" && "Ideas en movimiento. Escribir para entender."}
        {label === "Epistolario" && "Cartas y correspondencias. La intimidad como forma."}
      </p>

      <div class="mt-10 text-[10px] uppercase tracking-[0.3em] text-stone-400">
        {filteredWithAuthors.length} textos · Más recientes primero
      </div>
    </header>

    <section class="space-y-14 md:space-y-20">
      {filteredWithAuthors.map(({ post, author }) => (
        <PostPreview post={post} authorName={author.data.name} authorSlug={author.slug} />
      ))}
    </section>

    <footer class="mt-24 pt-16 border-t border-stone-100">
      <p class="text-[10px] uppercase tracking-[0.3em] text-stone-400 mb-6">
        Explorar otras secciones
      </p>

      <div class="flex flex-wrap gap-3 justify-center md:justify-start">
        {(["poesia","narrativa","critica","ensayo","epistolario"] as CategorySlug[])
          .filter((s) => s !== category)
          .map((s) => (
            <a
              href={`/categoria/${s}`}
              class="px-4 py-2 text-xs border border-stone-200 hover:border-stone-400 transition rounded-full"
            >
              {CATEGORY_LABEL[s]}
            </a>
          ))}
      </div>
    </footer>
  </div>
</Shell>
