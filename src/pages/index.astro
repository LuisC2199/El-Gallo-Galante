---
import Shell from "../layouts/Shell.astro";
import PostPreview from "../components/PostPreview.astro";
import { getCollection, getEntry, type CollectionEntry } from "astro:content";

const issues: CollectionEntry<"issues">[] = await getCollection("issues");

const latestIssue: CollectionEntry<"issues"> | undefined = issues
  .slice()
  .sort(
    (a: CollectionEntry<"issues">, b: CollectionEntry<"issues">) =>
      b.data.date.valueOf() - a.data.date.valueOf()
  )[0];

const posts: CollectionEntry<"posts">[] = await getCollection("posts");

const issuePosts: CollectionEntry<"posts">[] = latestIssue
  ? posts
      .filter((p: CollectionEntry<"posts">) => p.data.issue?.id === latestIssue.id)
      .slice()
      .sort(
        (a: CollectionEntry<"posts">, b: CollectionEntry<"posts">) =>
          b.data.date.valueOf() - a.data.date.valueOf()
      )
  : [];

const issuePostsWithAuthors: { post: CollectionEntry<"posts">; author: CollectionEntry<"authors"> }[] =
  await Promise.all(
    issuePosts.map(async (post: CollectionEntry<"posts">) => {
      const author = await getEntry(post.data.author);
      if (!author) throw new Error(`Author not found for post: ${post.slug}`);
      return { post, author };
    })
  );
---

<Shell title="El Gallo Galante">
  <div class="max-w-6xl mx-auto px-6">
    {latestIssue ? (
      <>
        <header class="max-w-3xl mx-auto mb-16 md:mb-24 text-center">
          <p class="text-[10px] tracking-[0.3em] uppercase font-bold text-stone-800 bg-stone-100 inline-block px-4 py-1">
            Última edición
          </p>

          <h1 class="display-serif text-4xl md:text-7xl font-bold leading-tight mt-6">
            {latestIssue.data.title}
          </h1>

          {latestIssue.data.description && (
            <p class="serif text-lg md:text-xl text-stone-500 leading-relaxed max-w-2xl mx-auto mt-6">
              {latestIssue.data.description}
            </p>
          )}
        </header>

        <section class="space-y-20">
			{issuePostsWithAuthors.map(({ post, author }) => (
			<PostPreview
				post={post}
				authorName={author.data.name}
				authorSlug={author.slug}
			/>
			))}
        </section>
      </>
    ) : (
      <div class="max-w-2xl mx-auto text-center py-20">
        <h1 class="display-serif text-4xl md:text-6xl font-bold leading-tight">El Gallo Galante</h1>
        <p class="serif text-stone-500 italic mt-6">Aún no hay ediciones publicadas.</p>
      </div>
    )}
  </div>
</Shell>
