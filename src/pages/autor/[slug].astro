---
import Shell from "../../layouts/Shell.astro";
import PostPreview from "../../components/PostPreview.astro";
import { getCollection, getEntry, type CollectionEntry } from "astro:content";

export async function getStaticPaths() {
  const authors: CollectionEntry<"authors">[] = await getCollection("authors");

  return authors.map((a: CollectionEntry<"authors">) => ({
    params: { slug: a.slug },
    props: { author: a },
  }));
}

const { author } = Astro.props as { author: CollectionEntry<"authors"> };
const posts: CollectionEntry<"posts">[] = await getCollection("posts");
const { Content } = await author.render();

const writtenWithAuthors: { post: CollectionEntry<"posts">; authorEntry: CollectionEntry<"authors"> }[] =
  (
    await Promise.all(
      posts.map(async (post: CollectionEntry<"posts">) => {
        const authorEntry = await getEntry(post.data.author);
        if (!authorEntry) return null;
        return { post, authorEntry };
      })
    )
  ).filter(
    (
      x: { post: CollectionEntry<"posts">; authorEntry: CollectionEntry<"authors"> } | null
    ): x is { post: CollectionEntry<"posts">; authorEntry: CollectionEntry<"authors"> } => x !== null
  );

const written: { post: CollectionEntry<"posts">; authorEntry: CollectionEntry<"authors"> }[] =
  writtenWithAuthors
    .filter(
      (x: { post: CollectionEntry<"posts">; authorEntry: CollectionEntry<"authors"> }) =>
        x.authorEntry.slug === author.slug
    )
    .sort(
      (
        a: { post: CollectionEntry<"posts">; authorEntry: CollectionEntry<"authors"> },
        b: { post: CollectionEntry<"posts">; authorEntry: CollectionEntry<"authors"> }
      ) => b.post.data.date.valueOf() - a.post.data.date.valueOf()
    );

---

<Shell title={`${author.data.name} Â· El Gallo Galante`}>
  <div class="max-w-6xl mx-auto px-6">
    <header class="max-w-6xl mx-auto mb-16 md:mb-24">
      <div class="grid grid-cols-1 md:grid-cols-[160px_1fr] gap-8 md:gap-10 items-start">
        {author.data.photo && (
          <img
            src={author.data.photo}
            alt={author.data.name}
            class="w-40 h-50 rounded-full grayscale object-cover"
            loading="lazy"
          />
        )}

        <div class="text-center md:text-left">
          <h1 class="display-serif text-4xl md:text-7xl font-bold leading-tight">
            {author.data.name}
          </h1>

          <p class="text-sm text-stone-400 font-light mt-4">
            ({author.data.birthYear}) {author.data.birthPlace}
          </p>

          <div class="serif text-lg md:text-xl text-stone-500 leading-relaxed italic max-w-2xl md:max-w-none mt-6">
            <Content />
          </div>

          {author.data.social && (
            <div class="mt-8 flex flex-wrap items-center justify-center md:justify-start gap-6 text-[10px] uppercase tracking-widest text-stone-400">
              {Object.entries(author.data.social)
                .filter(([_, value]) => typeof value === "string" && value.trim().length > 0)
                .map(([platform, url]) => (
                  <a
                    href={url}
                    target="_blank"
                    rel="noreferrer"
                    class="social-link flex items-center gap-2 hover:text-stone-800 transition-colors"
                  >
                    {platform === "website" && (
                      <svg width="16" height="16" viewBox="0 0 24 24" fill="none" class="opacity-80">
                        <circle cx="12" cy="12" r="9" stroke="currentColor" stroke-width="2" />
                        <path d="M3 12h18M12 3a15 15 0 0 1 0 18M12 3a15 15 0 0 0 0 18" stroke="currentColor" stroke-width="1.5"/>
                      </svg>
                    )}

                    {platform === "instagram" && (
                      <svg width="16" height="16" viewBox="0 0 24 24" fill="none" class="opacity-80">
                        <rect x="7" y="7" width="10" height="10" rx="3" stroke="currentColor" stroke-width="2"/>
                        <path d="M16.5 7.5h.01" stroke="currentColor" stroke-width="3" stroke-linecap="round"/>
                        <circle cx="12" cy="12" r="3" stroke="currentColor" stroke-width="2"/>
                      </svg>
                    )}

                    {platform === "x" && (
                      <svg width="16" height="16" viewBox="0 0 24 24" fill="none" class="opacity-80">
                        <path d="M6 18L18 6M6 6l12 12" stroke="currentColor" stroke-width="2" stroke-linecap="round"/>
                      </svg>
                    )}

                    {platform === "facebook" && (
                      <svg width="16" height="16" viewBox="0 0 24 24" fill="none" class="opacity-80">
                        <path d="M14 8h3V4h-3a5 5 0 0 0-5 5v3H6v4h3v8h4v-8h3l1-4h-4V9a1 1 0 0 1 1-1Z"
                          stroke="currentColor"
                          stroke-width="1.5"
                          fill="none"/>
                      </svg>
                    )}

                    {platform === "tiktok" && (
                      <svg width="16" height="16" viewBox="0 0 24 24" fill="none" class="opacity-80">
                        <path d="M14 4v10a4 4 0 1 1-4-4" stroke="currentColor" stroke-width="2"/>
                        <path d="M14 4c1 2 3 3 5 3" stroke="currentColor" stroke-width="2"/>
                      </svg>
                    )}

                    {{
                      website: "Sitio web",
                      instagram: "Instagram",
                      x: "X (Twitter)",
                      facebook: "Facebook",
                      tiktok: "TikTok",
                    }[platform] ?? platform}
                  </a>
                ))}
            </div>
          )}
        </div>
      </div>
    </header>

    <section class="space-y-20">
    {written.map(({ post }) => (
      <PostPreview post={post} authorName={author.data.name} authorSlug={author.slug} />
    ))}
    </section>
  </div>
</Shell>
