---
import Shell from "../../layouts/Shell.astro";
import PostPreview from "../../components/PostPreview.astro";
import { getCollection, getEntry, type CollectionEntry } from "astro:content";

export async function getStaticPaths() {
  const authors: CollectionEntry<"authors">[] = await getCollection("authors");

  return authors.map((a: CollectionEntry<"authors">) => ({
    params: { slug: a.slug },
    props: { author: a },
  }));
}

const { author } = Astro.props as { author: CollectionEntry<"authors"> };

const posts: CollectionEntry<"posts">[] = await getCollection("posts");

const { Content } = await author.render();

// Resolve each post's author and match by slug (robust)
const writtenWithAuthors: { post: CollectionEntry<"posts">; authorEntry: CollectionEntry<"authors"> }[] = (
    await Promise.all(
      posts.map(async (post: CollectionEntry<"posts">) => {
        const authorEntry = await getEntry(post.data.author);
        if (!authorEntry) return null;
        return { post, authorEntry };
      })
    )
  ).filter(
    (x: { post: CollectionEntry<"posts">; authorEntry: CollectionEntry<"authors"> } | null): x is {
      post: CollectionEntry<"posts">;
      authorEntry: CollectionEntry<"authors">;
    } => x !== null
  );

const written: CollectionEntry<"posts">[] = posts
  .filter((p: CollectionEntry<"posts">) => p.data.author.id === author.id)
  .slice()
  .sort(
    (a: CollectionEntry<"posts">, b: CollectionEntry<"posts">) =>
      b.data.date.valueOf() - a.data.date.valueOf()
  );
---

<Shell title={`${author.data.name} Â· El Gallo Galante`}>
  <div class="max-w-6xl mx-auto px-6">
    <header class="max-w-6xl mx-auto mb-16 md:mb-24">
      <div class="grid grid-cols-1 md:grid-cols-[160px_1fr] gap-8 md:gap-10 items-start">
        {author.data.photo && (
          <img
            src={author.data.photo}
            alt={author.data.name}
            class="w-40 h-50 rounded-full grayscale object-cover"
            loading="lazy"
          />
        )}

        <div class="text-center md:text-left">
          <h1 class="display-serif text-4xl md:text-7xl font-bold leading-tight">
            {author.data.name}
          </h1>

          <p class="text-sm text-stone-400 font-light mt-4">
            ({author.data.birthYear}) {author.data.birthPlace}
          </p>

          <div class="serif text-lg md:text-xl text-stone-500 leading-relaxed italic max-w-2xl md:max-w-none mt-6">
            <Content />
          </div>

          {author.data.social && (
            <div class="mt-8 flex flex-wrap items-center justify-center md:justify-start gap-6 text-[10px] uppercase tracking-widest text-stone-400">
              {author.data.social.website && (
                <a class="flex items-center gap-2 hover:text-stone-800 transition-colors" href={author.data.social.website} target="_blank" rel="noreferrer">
                  <svg width="14" height="14" viewBox="0 0 24 24" fill="none" class="opacity-80">
                    <path d="M10 14a5 5 0 0 1 0-7l1.5-1.5a5 5 0 0 1 7 7L17 14" stroke="currentColor" stroke-width="2" stroke-linecap="round"/>
                    <path d="M14 10a5 5 0 0 1 0 7L12.5 18.5a5 5 0 0 1-7-7L7 10" stroke="currentColor" stroke-width="2" stroke-linecap="round"/>
                  </svg>
                  Sitio
                </a>
              )}

              {author.data.social.instagram && (
                <a class="flex items-center gap-2 hover:text-stone-800 transition-colors" href={author.data.social.instagram} target="_blank" rel="noreferrer">
                  <svg width="14" height="14" viewBox="0 0 24 24" fill="none" class="opacity-80">
                    <rect x="7" y="7" width="10" height="10" rx="3" stroke="currentColor" stroke-width="2"/>
                    <path d="M16.5 7.5h.01" stroke="currentColor" stroke-width="3" stroke-linecap="round"/>
                    <path d="M12 15a3 3 0 1 0 0-6 3 3 0 0 0 0 6Z" stroke="currentColor" stroke-width="2"/>
                  </svg>
                  Instagram
                </a>
              )}

              {author.data.social.x && (
                <a class="flex items-center gap-2 hover:text-stone-800 transition-colors" href={author.data.social.x} target="_blank" rel="noreferrer">
                  <svg width="14" height="14" viewBox="0 0 24 24" fill="none" class="opacity-80">
                    <path d="M6 18L18 6" stroke="currentColor" stroke-width="2" stroke-linecap="round"/>
                    <path d="M8 6h4l4 12h-4L8 6Z" stroke="currentColor" stroke-width="2" stroke-linejoin="round"/>
                  </svg>
                  X
                </a>
              )}
            </div>
          )}
        </div>
      </div>
    </header>

    <section class="space-y-20">
      {written.map((post: CollectionEntry<"posts">) => (
        <PostPreview post={post} authorName={author.data.name} authorSlug={author.slug} />
      ))}
    </section>
  </div>
</Shell>
